#!/bin/bash
#
# Sudoers configuration for {{ username }}
# Generated by OpsArtisan
#

set -euo pipefail

# Check if running as root
if [ "$EUID" -ne 0 ]; then
    echo "ERROR: This script must be run as root"
    exit 1
fi

USERNAME="{{ username }}"
SUDOERS_FILE="/etc/sudoers.d/${USERNAME}"

echo "==> Configuring sudo for ${USERNAME}"

{% if sudo_nopasswd and configuration_mode == 'advanced' %}
# Allow sudo without password
cat > "${SUDOERS_FILE}" << EOF
# Sudo configuration for ${USERNAME}
# Generated by OpsArtisan
${USERNAME} ALL=(ALL) NOPASSWD:ALL
EOF
echo "==> Sudo without password enabled"
{% else %}
# Require password for sudo
cat > "${SUDOERS_FILE}" << EOF
# Sudo configuration for ${USERNAME}
# Generated by OpsArtisan
${USERNAME} ALL=(ALL:ALL) ALL
EOF
echo "==> Sudo with password enabled"
{% endif %}

# Set proper permissions
chmod 440 "${SUDOERS_FILE}"

# Validate sudoers file
if visudo -c -f "${SUDOERS_FILE}"; then
    echo "==> Sudoers file validated successfully"
else
    echo "ERROR: Invalid sudoers file"
    rm -f "${SUDOERS_FILE}"
    exit 1
fi

echo "==> Sudo configuration complete"
echo "Test with: sudo -u ${USERNAME} sudo -v"
