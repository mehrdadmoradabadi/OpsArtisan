#!/bin/bash
#
# Terraform apply script
# Generated by OpsArtisan
#

set -euo pipefail

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}==> Terraform Apply${NC}"
echo "Project: {{ project_name }}"
echo "Environment: {{ environment }}"
echo ""

# Check if plan exists
if [ ! -f "tfplan" ]; then
    echo -e "${YELLOW}No plan file found. Running plan first...${NC}"
    bash scripts/plan.sh
    echo ""
fi

# Safety confirmation
echo -e "${YELLOW}⚠️  WARNING: This will modify infrastructure${NC}"
echo ""
read -p "Are you sure you want to apply these changes? (yes/no) " -r
if [[ ! $REPLY =~ ^[Yy][Ee][Ss]$ ]]; then
    echo "Apply cancelled"
    exit 0
fi

# Apply
echo ""
echo -e "${BLUE}==> Applying changes${NC}"
terraform apply tfplan

if [ $? -eq 0 ]; then
    echo ""
    echo -e "${GREEN}✓ Infrastructure deployed successfully${NC}"
    echo ""

    # Show outputs
    echo -e "${BLUE}==> Outputs${NC}"
    terraform output

    # Clean up plan file
    rm -f tfplan

    echo ""
    echo "Infrastructure is ready!"
    {% if enable_rds %}
    echo ""
    echo -e "${YELLOW}Database credentials:${NC}"
    echo "Password stored in AWS Secrets Manager"
    echo "Retrieve with: aws secretsmanager get-secret-value --secret-id {{ project_name }}-{{ environment }}-db-password"
    {% endif %}
else
    echo -e "${RED}Apply failed${NC}"
    exit 1
fi