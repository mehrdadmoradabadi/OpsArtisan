# Alert rules for {{ job_name }}
# Generated by OpsArtisan

groups:
  - name: {{ job_name }}_alerts
    interval: 30s
    rules:
      {% if configuration_mode == 'simple' or 'availability' in (alert_types if configuration_mode == 'advanced' and alert_types else 'availability') %}
      # Availability Alerts
      - alert: {{ job_name | title }}Down
        expr: up{job="{{ job_name }}"} == 0
        for: 5m
        labels:
          severity: critical
          component: {{ job_name }}
        annotations:
          summary: "{{ job_name }} instance is down"
          description: "{{ job_name }} instance {{ '{{' }} $labels.instance {{ '}}' }} has been down for more than 5 minutes."

      - alert: {{ job_name | title }}HighErrorRate
        expr: |
          rate({{ job_name }}_errors_total[5m]) > 0.05
        for: 5m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "High error rate on {{ job_name }}"
          description: "{{ job_name }} on {{ '{{' }} $labels.instance {{ '}}' }} has error rate of {{ '{{' }} $value | humanizePercentage {{ '}}' }}"

      {% endif %}
      {% if configuration_mode == 'advanced' and 'latency' in alert_types %}
      # Latency Alerts
      - alert: {{ job_name | title }}HighLatency
        expr: |
          histogram_quantile(0.95,
            rate({{ job_name }}_request_duration_seconds_bucket[5m])
          ) > 1
        for: 10m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "High latency on {{ job_name }}"
          description: "{{ job_name }} 95th percentile latency is {{ '{{' }} $value | humanizeDuration {{ '}}' }} on {{ '{{' }} $labels.instance {{ '}}' }}"

      - alert: {{ job_name | title }}VeryHighLatency
        expr: |
          histogram_quantile(0.95,
            rate({{ job_name }}_request_duration_seconds_bucket[5m])
          ) > 5
        for: 5m
        labels:
          severity: critical
          component: {{ job_name }}
        annotations:
          summary: "Very high latency on {{ job_name }}"
          description: "{{ job_name }} 95th percentile latency is {{ '{{' }} $value | humanizeDuration {{ '}}' }} on {{ '{{' }} $labels.instance {{ '}}' }}"

      {% endif %}
      {% if configuration_mode == 'advanced' and 'errors' in alert_types %}
      # Error Rate Alerts
      - alert: {{ job_name | title }}4xxErrors
        expr: |
          rate({{ job_name }}_http_requests_total{status=~"4.."}[5m]) > 0.1
        for: 5m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "High 4xx error rate on {{ job_name }}"
          description: "{{ job_name }} has 4xx error rate of {{ '{{' }} $value | humanizePercentage {{ '}}' }}"

      - alert: {{ job_name | title }}5xxErrors
        expr: |
          rate({{ job_name }}_http_requests_total{status=~"5.."}[5m]) > 0.05
        for: 5m
        labels:
          severity: critical
          component: {{ job_name }}
        annotations:
          summary: "High 5xx error rate on {{ job_name }}"
          description: "{{ job_name }} has 5xx error rate of {{ '{{' }} $value | humanizePercentage {{ '}}' }}"

      {% endif %}
      {% if configuration_mode == 'advanced' and 'resources' in alert_types %}
      # Resource Alerts
      - alert: {{ job_name | title }}HighCPU
        expr: |
          rate(process_cpu_seconds_total{job="{{ job_name }}"}[5m]) > 0.8
        for: 10m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "High CPU usage on {{ job_name }}"
          description: "{{ job_name }} CPU usage is {{ '{{' }} $value | humanizePercentage {{ '}}' }} on {{ '{{' }} $labels.instance {{ '}}' }}"

      - alert: {{ job_name | title }}HighMemory
        expr: |
          process_resident_memory_bytes{job="{{ job_name }}"} /
          node_memory_MemTotal_bytes > 0.8
        for: 10m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "High memory usage on {{ job_name }}"
          description: "{{ job_name }} memory usage is {{ '{{' }} $value | humanizePercentage {{ '}}' }} on {{ '{{' }} $labels.instance {{ '}}' }}"

      - alert: {{ job_name | title }}TooManyRestarts
        expr: |
          rate({{ job_name }}_restarts_total[15m]) > 2
        for: 5m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "{{ job_name }} is restarting frequently"
          description: "{{ job_name }} on {{ '{{' }} $labels.instance {{ '}}' }} has restarted {{ '{{' }} $value {{ '}}' }} times in 15 minutes"

      {% endif %}
      {% if configuration_mode == 'simple' %}
      - alert: {{ job_name | title }}SlowScrape
        expr: |
          scrape_duration_seconds{job="{{ job_name }}"} > 10
        for: 5m
        labels:
          severity: warning
          component: {{ job_name }}
        annotations:
          summary: "Slow scrape detected"
          description: "Scraping {{ job_name }} on {{ '{{' }} $labels.instance {{ '}}' }} takes {{ '{{' }} $value | humanizeDuration {{ '}}' }}"
      {% endif %}
