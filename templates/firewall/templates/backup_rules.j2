#!/bin/bash
#
# Firewall backup script
# Generated by OpsArtisan
#

set -euo pipefail

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

FIREWALL_TYPE="{{ firewall_type }}"
BACKUP_DIR="./firewall-backups"
TIMESTAMP=$(date +%Y%m%d_%H%M%S)

# Create backup directory
mkdir -p "${BACKUP_DIR}"

echo -e "${BLUE}==> Backing up firewall rules${NC}"
echo "Type: ${FIREWALL_TYPE}"
echo ""

{% if firewall_type == 'ufw' %}
if command -v ufw &> /dev/null; then
    echo "Backing up UFW rules..."

    # Backup UFW status and rules
    ufw status numbered > "${BACKUP_DIR}/ufw-rules-${TIMESTAMP}.txt"

    # Backup UFW files
    if [ -d /etc/ufw ]; then
        tar -czf "${BACKUP_DIR}/ufw-config-${TIMESTAMP}.tar.gz" /etc/ufw/ 2>/dev/null
    fi

    echo -e "${GREEN}✓ UFW rules backed up${NC}"
    echo "  Rules: ${BACKUP_DIR}/ufw-rules-${TIMESTAMP}.txt"
    echo "  Config: ${BACKUP_DIR}/ufw-config-${TIMESTAMP}.tar.gz"
fi

{% elif firewall_type == 'iptables' %}
if command -v iptables &> /dev/null; then
    echo "Backing up iptables rules..."

    # Backup IPv4 rules
    iptables-save > "${BACKUP_DIR}/iptables-${TIMESTAMP}.rules"

    # Backup IPv6 rules if available
    if command -v ip6tables &> /dev/null; then
        ip6tables-save > "${BACKUP_DIR}/ip6tables-${TIMESTAMP}.rules"
    fi

    echo -e "${GREEN}✓ iptables rules backed up${NC}"
    echo "  IPv4: ${BACKUP_DIR}/iptables-${TIMESTAMP}.rules"
    if [ -f "${BACKUP_DIR}/ip6tables-${TIMESTAMP}.rules" ]; then
        echo "  IPv6: ${BACKUP_DIR}/ip6tables-${TIMESTAMP}.rules"
    fi
fi

{% elif firewall_type == 'nftables' %}
if command -v nft &> /dev/null; then
    echo "Backing up nftables rules..."

    # Backup nftables ruleset
    nft list ruleset > "${BACKUP_DIR}/nftables-${TIMESTAMP}.rules"

    echo -e "${GREEN}✓ nftables rules backed up${NC}"
    echo "  Rules: ${BACKUP_DIR}/nftables-${TIMESTAMP}.rules"
fi
{% endif %}

# Restore function
if [ "${1:-}" = "restore" ]; then
    echo ""
    echo -e "${YELLOW}==> Available backups:${NC}"
    ls -lht "${BACKUP_DIR}" | head -10
    echo ""
    read -p "Enter backup file to restore: " RESTORE_FILE

    if [ ! -f "${RESTORE_FILE}" ]; then
        echo "File not found: ${RESTORE_FILE}"
        exit 1
    fi

    echo "Restoring from: ${RESTORE_FILE}"

    {% if firewall_type == 'ufw' %}
    ufw --force reset
    # Manual restoration needed - UFW doesn't support direct restore
    echo "Please manually apply rules from: ${RESTORE_FILE}"

    {% elif firewall_type == 'iptables' %}
    iptables-restore < "${RESTORE_FILE}"
    echo -e "${GREEN}✓ iptables rules restored${NC}"

    {% elif firewall_type == 'nftables' %}
    nft -f "${RESTORE_FILE}"
    echo -e "${GREEN}✓ nftables rules restored${NC}"
    {% endif %}
fi

echo ""
echo "Backup complete"
