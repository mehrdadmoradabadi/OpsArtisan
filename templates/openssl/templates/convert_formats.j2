#!/bin/bash
#
# Certificate format conversion script
# Generated by OpsArtisan
#

set -euo pipefail

CN="{{ common_name }}"
OUTPUT_DIR="{{ output_directory }}"

# Colors
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
BLUE='\033[0;34m'
NC='\033[0m'

echo -e "${BLUE}==> Certificate Format Converter${NC}"
echo ""

cd "${OUTPUT_DIR}"

# Check if certificate and key exist
if [ ! -f "${CN}.crt" ]; then
    echo "ERROR: Certificate ${CN}.crt not found"
    exit 1
fi

if [ ! -f "${CN}.key" ]; then
    echo "ERROR: Private key ${CN}.key not found"
    exit 1
fi

echo "Converting certificate formats for: ${CN}"
echo ""

# PEM to DER
echo "==> Converting to DER format"
openssl x509 -in "${CN}.crt" -outform DER -out "${CN}.der"
openssl rsa -in "${CN}.key" -outform DER -out "${CN}.key.der" 2>/dev/null
echo -e "${GREEN}✓ Certificate: ${CN}.der${NC}"
echo -e "${GREEN}✓ Key: ${CN}.key.der${NC}"
echo ""

# PEM to PKCS12
echo "==> Converting to PKCS12 format"
echo "Enter export password for PKCS12 bundle:"
openssl pkcs12 -export -in "${CN}.crt" -inkey "${CN}.key" \
    -out "${CN}.p12" -name "${CN}" \
    -certfile "${CN}.crt"
echo -e "${GREEN}✓ PKCS12 bundle: ${CN}.p12${NC}"
echo ""

# Extract information about the PKCS12
echo "==> PKCS12 bundle contents"
openssl pkcs12 -in "${CN}.p12" -info -noout -passin pass: 2>/dev/null || \
    echo "Run: openssl pkcs12 -in ${CN}.p12 -info -noout"
echo ""

# PEM to PKCS7
echo "==> Converting to PKCS7 format"
openssl crl2pkcs7 -nocrl -certfile "${CN}.crt" -out "${CN}.p7b"
echo -e "${GREEN}✓ PKCS7: ${CN}.p7b${NC}"
echo ""

echo -e "${BLUE}==> Conversion complete!${NC}"
echo ""
echo "Available formats:"
echo "  - PEM: ${CN}.crt, ${CN}.key (most common)"
echo "  - DER: ${CN}.der, ${CN}.key.der (binary format)"
echo "  - PKCS12: ${CN}.p12 (for Windows/Java)"
echo "  - PKCS7: ${CN}.p7b (certificate only)"
echo ""
echo -e "${YELLOW}Format usage:${NC}"
echo "  - Apache/Nginx: Use PEM (.crt, .key)"
echo "  - Windows IIS: Use PKCS12 (.p12)"
echo "  - Java keystore: Use PKCS12 (.p12)"
echo "  - Email signing: Use PKCS7 (.p7b)"