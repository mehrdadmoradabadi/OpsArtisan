{% if configuration_mode == 'simple' %}
# Simple Apache configuration for {{ server_name }}
# Generated by OpsArtisan

<VirtualHost *:80>
    ServerName {{ server_name }}
    DocumentRoot {{ root_dir }}

    {% if tls_enabled %}
    SSLEngine on
    SSLCertificateFile {{ tls_cert }}
    SSLCertificateKeyFile {{ tls_key }}
    {% endif %}

    <Directory {{ root_dir }}>
        AllowOverride All
        Require all granted
    </Directory>
</VirtualHost>

{% else %}
# Advanced Apache configuration for {{ server_name }}
# Generated by OpsArtisan

{% if redirect_http_to_https and tls_enabled %}
# HTTP to HTTPS redirect
<VirtualHost *:80>
    ServerName {{ server_name }}
    {% if server_aliases %}
    ServerAlias {{ server_aliases }}
    {% endif %}

    # Let's Encrypt challenge
    Alias /.well-known/acme-challenge/ /var/www/letsencrypt/.well-known/acme-challenge/
    <Directory "/var/www/letsencrypt/.well-known/acme-challenge/">
        Options None
        AllowOverride None
        Require all granted
    </Directory>

    # Redirect all other traffic to HTTPS
    RewriteEngine On
    RewriteCond %{REQUEST_URI} !^/\.well-known/acme-challenge/
    RewriteRule ^(.*)$ https://%{HTTP_HOST}$1 [R=301,L]
</VirtualHost>

{% endif %}
# HTTPS Virtual Host
<VirtualHost *:{% if tls_enabled %}443{% else %}80{% endif %}>
    ServerName {{ server_name }}
    {% if server_aliases %}
    ServerAlias {{ server_aliases }}
    {% endif %}

    DocumentRoot {{ root_dir }}

    # Logging
    ErrorLog {{ error_log }}
    CustomLog {{ access_log }} combined

    {% if tls_enabled %}
    # SSL Configuration
    SSLEngine on
    SSLCertificateFile {{ tls_cert }}
    SSLCertificateKeyFile {{ tls_key }}

    # Modern SSL configuration
    SSLProtocol all -SSLv3 -TLSv1 -TLSv1.1
    SSLCipherSuite ECDHE-ECDSA-AES128-GCM-SHA256:ECDHE-RSA-AES128-GCM-SHA256:ECDHE-ECDSA-AES256-GCM-SHA384:ECDHE-RSA-AES256-GCM-SHA384
    SSLHonorCipherOrder off

    # SSL Session Cache
    SSLSessionCache "shmcb:/var/run/apache2/ssl_scache(512000)"
    SSLSessionCacheTimeout 300

    # OCSP Stapling
    SSLUseStapling on
    SSLStaplingResponderTimeout 5
    SSLStaplingReturnResponderErrors off

    {% if http2_enabled %}
    # Enable HTTP/2
    Protocols h2 http/1.1
    {% endif %}
    {% endif %}

    {% if security_headers %}
    # Security Headers
    Header always set Strict-Transport-Security "max-age=31536000; includeSubDomains; preload"
    Header always set X-Frame-Options "SAMEORIGIN"
    Header always set X-Content-Type-Options "nosniff"
    Header always set X-XSS-Protection "1; mode=block"
    Header always set Referrer-Policy "no-referrer-when-downgrade"
    Header always set Content-Security-Policy "default-src 'self' http: https: data: blob: 'unsafe-inline'"
    {% endif %}

    {% if gzip_enabled %}
    # Compression
    <IfModule mod_deflate.c>
        AddOutputFilterByType DEFLATE text/html text/plain text/xml text/css text/javascript
        AddOutputFilterByType DEFLATE application/javascript application/json application/xml
    </IfModule>
    {% endif %}

    <Directory {{ root_dir }}>
        Options {% if application_type == 'php' %}+FollowSymLinks -Indexes{% else %}-Indexes +FollowSymLinks{% endif %}
        AllowOverride All
        Require all granted

        {% if application_type == 'spa' %}
        # SPA routing
        RewriteEngine On
        RewriteBase /
        RewriteRule ^index\.html$ - [L]
        RewriteCond %{REQUEST_FILENAME} !-f
        RewriteCond %{REQUEST_FILENAME} !-d
        RewriteRule . /index.html [L]
        {% endif %}
    </Directory>

    {% if application_type == 'php' %}
    # PHP-FPM Configuration
    <FilesMatch \.php$>
        SetHandler "proxy:unix:/var/run/php/php{{ php_version }}-fpm.sock|fcgi://localhost"
    </FilesMatch>

    # Deny access to hidden files
    <FilesMatch "^\.">
        Require all denied
    </FilesMatch>
    {% endif %}

    {% if application_type == 'proxy' %}
    # Reverse Proxy Configuration
    ProxyPreserveHost On
    ProxyPass / {{ proxy_pass }}/
    ProxyPassReverse / {{ proxy_pass }}/

    # Proxy headers
    RequestHeader set X-Forwarded-Proto "https"
    RequestHeader set X-Forwarded-Port "443"
    {% endif %}

    {% if caching %}
    # Browser Caching
    <IfModule mod_expires.c>
        ExpiresActive On
        ExpiresByType image/jpg "access plus 1 year"
        ExpiresByType image/jpeg "access plus 1 year"
        ExpiresByType image/gif "access plus 1 year"
        ExpiresByType image/png "access plus 1 year"
        ExpiresByType image/svg+xml "access plus 1 year"
        ExpiresByType text/css "access plus 1 year"
        ExpiresByType application/javascript "access plus 1 year"
        ExpiresByType application/font-woff "access plus 1 year"
        ExpiresByType application/font-woff2 "access plus 1 year"
    </IfModule>
    {% endif %}

    # Health check
    <Location /health>
        SetHandler None
        Require all granted
    </Location>
</VirtualHost>

{% if tls_enabled %}
# SSL Stapling Cache
<IfModule mod_ssl.c>
    SSLStaplingCache "shmcb:/var/run/apache2/stapling_cache(128000)"
</IfModule>
{% endif %}
{% endif %}
