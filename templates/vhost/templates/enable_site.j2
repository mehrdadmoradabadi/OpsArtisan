#!/bin/bash
#
# Enable {{ server_name }} site
# Generated by OpsArtisan
#

set -euo pipefail

if [ "$EUID" -ne 0 ]; then
    echo "ERROR: This script must be run as root"
    exit 1
fi

SERVER_TYPE="{{ server_type }}"
SERVER_NAME="{{ server_name }}"
CONFIG_FILE="{{ server_name }}.conf"

echo "==> Enabling ${SERVER_NAME} on ${SERVER_TYPE}"

if [ "${SERVER_TYPE}" == "nginx" ]; then
    # Nginx
    AVAILABLE_DIR="/etc/nginx/sites-available"
    ENABLED_DIR="/etc/nginx/sites-enabled"

    # Copy config
    cp "${CONFIG_FILE}" "${AVAILABLE_DIR}/"
    {% if configuration_mode == 'advanced' and tls_enabled %}
    cp "{{ server_name }}-ssl.conf" /etc/nginx/snippets/ 2>/dev/null || true
    {% endif %}

    # Enable site
    ln -sf "${AVAILABLE_DIR}/${CONFIG_FILE}" "${ENABLED_DIR}/"

    # Test and reload
    if nginx -t; then
        systemctl reload nginx
        echo "==> Nginx reloaded successfully"
    else
        echo "ERROR: Nginx configuration test failed"
        exit 1
    fi

elif [ "${SERVER_TYPE}" == "apache" ]; then
    # Apache
    AVAILABLE_DIR="/etc/apache2/sites-available"

    # Copy config
    cp "${CONFIG_FILE}" "${AVAILABLE_DIR}/"

    # Enable required modules
    {% if tls_enabled %}
    a2enmod ssl
    {% endif %}
    {% if http2_enabled and configuration_mode == 'advanced' %}
    a2enmod http2
    {% endif %}
    {% if security_headers and configuration_mode == 'advanced' %}
    a2enmod headers
    {% endif %}
    a2enmod rewrite
    {% if application_type == 'proxy' and configuration_mode == 'advanced' %}
    a2enmod proxy proxy_http
    {% endif %}
    {% if application_type == 'php' and configuration_mode == 'advanced' %}
    a2enmod proxy_fcgi
    {% endif %}

    # Enable site
    a2ensite "${SERVER_NAME}"

    # Test and reload
    if apache2ctl configtest; then
        systemctl reload apache2
        echo "==> Apache reloaded successfully"
    else
        echo "ERROR: Apache configuration test failed"
        exit 1
    fi
fi

echo ""
echo "==> Site enabled successfully!"
echo "Visit: http{% if tls_enabled %}s{% endif %}://{{ server_name }}"
